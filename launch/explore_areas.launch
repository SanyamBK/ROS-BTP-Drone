<?xml version="1.0"?>
<launch>
  
  <!-- Launch Gazebo (Empty World) -->
  <env name="GAZEBO_MODEL_PATH" value="$(find multi_drone_sim)/models:/usr/share/gazebo-11/models:${GAZEBO_MODEL_PATH}" />
  <include file="$(find gazebo_ros)/launch/empty_world.launch">
    <arg name="world_name" value="$(find multi_drone_sim)/worlds/field_areas.world"/>
    <arg name="gui" value="true"/>
  </include>

  <!-- Sequential Swarm Spawning (Fixes missing drones) -->
  <node name="spawn_fleet" pkg="multi_drone_sim" type="spawn_fleet.py" output="screen" />
  
  <!-- Start the area exploration controller -->
  <node name="area_explorer" pkg="multi_drone_sim" type="area_explorer.py" output="screen">
    <param name="config_path" value="$(find multi_drone_sim)/config/areas.yaml"/>
  </node>
  
  <!-- ========================================== -->
  <!-- Phase 2: Research Implementation Nodes     -->
  <!-- ========================================== -->

  <!-- 1. Swarm Ranging (INFOCOM 2021) -->
  <node name="uwb_simulator" pkg="multi_drone_sim" type="uwb_simulator.py" output="screen" />
  
  <!-- Decentralized Localization (Running for sample subset of swarm) -->
  <node name="swarm_loc_0" pkg="multi_drone_sim" type="swarm_localization.py" output="screen">
    <param name="drone_id" value="0"/>
  </node>
  <node name="swarm_loc_1" pkg="multi_drone_sim" type="swarm_localization.py" output="screen">
    <param name="drone_id" value="1"/>
  </node>
  <node name="swarm_loc_2" pkg="multi_drone_sim" type="swarm_localization.py" output="screen">
    <param name="drone_id" value="2"/>
  </node>

  <!-- 2. Energy-Aware Planning (ICRA 2024) -->
  <!-- Mobile Charging Station -->
  <!-- UGV #1 -->
  <node name="ugv1_manager" pkg="multi_drone_sim" type="ugv_manager.py" output="screen">
    <param name="namespace" value="ugv1" />
    <param name="ugv_id" value="UGV 1" />
    <param name="model_name" value="UGV_Charger" />
    <param name="start_x" value="0.0" />
    <param name="start_y" value="0.0" />
    <param name="other_ugv_odom_topic" value="/ugv2/odom" />
    <param name="min_separation" value="2.0" />
    <rosparam param="patrol_waypoints">[[-12, 5], [-2, 5], [-2, 12], [-12, 12]]</rosparam>
  </node>
  
  <!-- UGV #2 (different patrol loop + opposite corner start) -->
  <node name="ugv2_manager" pkg="multi_drone_sim" type="ugv_manager.py" output="screen">
    <param name="namespace" value="ugv2" />
    <param name="ugv_id" value="UGV 2" />
    <param name="model_name" value="UGV_Charger_2" />
    <param name="start_x" value="-14.0" />
    <param name="start_y" value="14.0" />
    <param name="other_ugv_odom_topic" value="/ugv1/odom" />
    <param name="min_separation" value="2.0" />
    <!-- Larger outer loop so it doesn't overlap UGV #1's tighter loop -->
    <rosparam param="patrol_waypoints">[[-16, 2], [2, 2], [2, 16], [-16, 16]]</rosparam>
  </node>
  

  <!-- VISUALS: Spawn UGV Model (Custom Mobile Charger URDF) -->
  <param name="ugv_description" textfile="$(find multi_drone_sim)/models/urdf/mobile_charger.urdf" />
  
  <node name="spawn_ugv" pkg="gazebo_ros" type="spawn_model" 
        args="-urdf -param ugv_description -model UGV_Charger -x 0.0 -y 0.0 -z 0.325"
        output="screen"/>

  <!-- VISUALS: Spawn UGV Model #2 -->
  <node name="spawn_ugv_2" pkg="gazebo_ros" type="spawn_model" 
    args="-urdf -param ugv_description -model UGV_Charger_2 -x -14.0 -y 14.0 -z 0.325"
    output="screen"/>

  <!-- VISUALS: Spawn Custom Orange Drone (Disabled)
  <node name="spawn_ugv" pkg="gazebo_ros" type="spawn_model" 
        args="-sdf -file $(find multi_drone_sim)/models/quadcopter_ugv/model.sdf -model UGV_Charger -x 0.0 -y 0.0 -z 0.2"
        output="screen"/>
  -->


  
  <!-- 3. Centralized Communication Architecture -->
  <node name="central_agent" pkg="multi_drone_sim" type="central_agent.py" output="screen" />
  <node name="drone_comms" pkg="multi_drone_sim" type="drone_comm.py" output="screen" />
  <node name="ugv_comms" pkg="multi_drone_sim" type="ugv_comm.py" output="screen" />

  <!-- Coordinated Planner -->
  <node name="energy_planner" pkg="multi_drone_sim" type="energy_planner.py" output="screen" />

</launch>
